# 113-1 資料庫管理 - 第33組 - 歌手點點名（金曲獎資料庫）

## 專案簡介

金曲獎自 1990 年首次舉辦後，今年已邁入第 35 屆，為台灣歷史最悠久、影響力最大的音樂獎項。金曲獎涵蓋多種語言，從華語、台語、客語到原住民語，累積了大量的忠實觀眾。然而，觀眾在回味歷屆金曲獎的歌曲或想了解某位歌手的歷年表現時，常因龐大的資訊量而無法篩選出特定獎項的曲目，或無法方便地查詢歌手資料。

「歌手點點名」旨在解決上述問題，這是一款幫助觀眾深入了解歌手的平台，不僅能查詢歌手及歌曲的基本資訊，還能查看歷屆金曲獎熱門獎項的得獎名單和表演曲目。此外，為了讓觀眾的聲音被聽見，我們設計了投票功能，讓觀眾能支持最喜愛的歌手。平台也設計了評論的功能，讓觀眾能對表演進行評論交流。

:link: **[展示影片連結](https://youtu.be/z-0VkQdeV8U?si=9KYCEIdP1v8TP63L)**

## 使用者功能

### User （一般使用者）

#### 使用者登入、註冊
- 註冊：使用者可以註冊帳號設定使用者名稱、密碼及電子郵件信箱，系統會分配一個 user_id 給每位使用者。
- 登入：使用系統分配的 user_id 登入並驗證密碼。

#### 查詢特定歌手、歌曲或專輯的入圍／得獎情形：
- 使用者可以查詢特定歌手、歌曲或專輯的歷屆入圍與得獎紀錄，快速了解感興趣的歌手或作品在歷年金曲獎中的表現。

#### 新增評論：
- 使用者可以針對金曲獎歷屆表演節目新增評論，選擇特定表演後輸入評論內容，評論將被保存至資料庫中。

#### 查詢自己的評論：
- 使用者可以查詢自己所有的評論記錄，包括有效及已刪除的評論。

#### 修改／刪除自己的評論：
- 使用者可以修改或刪除已新增的評論，確保評論內容符合自身需求。

#### 查詢特定表演的評論：
- 使用者可以查詢金曲獎特定表演的所有評論，快速了解觀眾的反饋與評價。

#### 新增投票：
- 使用者可以針對當屆的入圍歌手進行人氣投票，每人每日僅限投票一次。

#### 查詢自己的投票：
- 使用者可以查詢自己過往的投票記錄，系統將僅顯示有效的投票資料。

#### 修改／刪除自己的投票：
- 使用者可以修改或刪除當天的投票記錄，重新選擇人氣歌手進行投票。

#### 查詢人氣歌手的票數：
- 使用者可以查詢特定屆次的所有入圍歌手票數，了解該屆人氣歌手的票選情況。

#### 隨機建立歌單：
- 使用者可以從所有入圍的歌曲中隨機挑選指定數量的歌曲建立歌單。


### Admin （管理員／業務經營者）

#### 管理歌手及作品資訊：
- 管理員可新增、修改或刪除歌手、專輯及歌曲資訊。新增功能包括新增歌手（名稱、性別、生日）、專輯（名稱及歌手 ID）、歌曲（名稱及歌手 ID）。修改功能允許更新名稱及相關資訊，刪除功能則可透過 ID 移除資料。

#### 管理典禮資訊：
- 管理員新增／修改／刪除金曲獎典禮的相關資訊，包括屆次及其他詳細內容。

#### 管理入圍資訊：
- 管理員可新增／修改／刪除歌手、歌曲或專輯的入圍資料，需輸入屆次、獎項名稱及對應的 ID。

#### 管理得獎資訊：
- 管理員可根據入圍 ID 新增／修改／刪除歌手、歌曲或專輯的得獎資訊。

#### 管理表演資訊：
- 管理員可新增／修改／刪除金曲獎表演節目，需輸入屆次、表演名稱及表演歌手的 ID。

#### 檢視／刪除投票：
- 管理員可查閱所有的投票記錄，並針對可疑投票進行刪除，便於監控和管理。

#### 檢視／刪除評論：
- 管理員可查閱所有的評論記錄，並針對不雅評論進行刪除，便於審核和追蹤。


## 使用方法

- 使用備份檔 `歌手點點名.backup` 復原資料庫
- 預設連線通道為 **127.0.0.1:8800**，可至 `server.py` 及 `client.py` 修改
- 在 `DB_utils.py` 設定**資料庫名稱** (DB_NAME)、**使用者名稱** (DB_USER)、**主機位置** (DB_HOST)及**通訊埠** (DB_PORT)、**密碼**(password)

先執行 `server.py` 啟動伺服器：

```bash
python .\server.py 
```

再透過 `client.py` 向伺服器連線：

```bash
python .\client.py 
```

## 技術細節

- 使用 Socket 建立 client-server 連線，搭配 Multithreading 達成多人同時連線。

- 資料庫使用 PostgreSQL，並透過套件 Psycopg2 與資料庫進行互動操作。

- **交易管理**：針對【評論修改與刪除】功能，為實現交易管理，在寫入評論時若出現違反資料表限制或操作衝突（如評論已被刪除），系統將立即停止操作，並執行 ROLLBACK 回滾交易，取消所有未完成的異動。反之，若操作過程順利完成，則會執行 COMMIT 提交交易，確保評論正確儲存。

  - 可參考 `./DB_util.py` 中的 `comment()` 與 `update_comment()`。

- **併行控制**：針對【評論修改與刪除】功能，為避免同一評論被多台設備同時操作（例如，一台設備刪除評論時，另一台設備嘗試修改該評論），系統採用雙重鎖機制。在應用層，透過 Python 的 Threading 套件為每個 `comment_id` 動態分配鎖，確保同一時間僅有一個執行緒操作該評論；在資料庫層，使用 PostgreSQL 的行級鎖（`SELECT ... FOR UPDATE`）進一步避免資料競爭，確保評論狀態一致。

  - 可參考 `./DB_util.py` 中的 `update_comment()`。

  
## 程式說明


1. **`server.py`** (伺服器端主要邏輯)
   - 負責啟動伺服器並處理多個客戶端連線，透過執行緒並行處理請求。
   - 使用 `socket` 建立 TCP 連線，監聽 `127.0.0.1:8800`。
   - 提供登入、註冊等選項，並根據使用者角色（例如 Admin 或 User）調用相應的功能模組。

2. **`client.py`** (客戶端程式)
   - 客戶端與伺服器建立 TCP 連線並處理資料交換。
   - 包括接收伺服器訊息的功能，例如請求輸入、上傳檔案或關閉連線。
   - 當收到指定標籤訊息（如 `[INPUT]` ）時，執行特定的用戶操作，例如接受使用者輸入。

3. **`DB_utils.py`** (資料庫操作工具)
   - 提供資料庫操作的封裝，例如建立連線、執行查詢以及列印表格。
   - 包含對應專案需求的資料表操作函式，如新增、更新、刪除用戶、藝術家、專輯和歌曲等。
   - 涉及鎖定機制（`Lock`）以確保某些操作的併發安全性，例如處理評論的新增或更新。

4. **`Role.py`** (角色基底類別)
   - 定義使用者角色的基礎屬性與方法，如取得使用者資訊、行為列表等。
   - 提供方法讓子類別（如 Admin 和 User）擴展特定行為。

5. **`Admin.py`** (管理員角色)
   - 繼承自基底類別 `Role`，提供管理員專屬的操作，例如管理歌曲、專輯、表演和獎項等。
   - 包含管理功能的行為清單，進一步區分普通使用者與管理員的權限。

6. **`User.py`** (一般使用者角色)
   - 繼承自 `Role`，為一般使用者提供基本功能，例如投票、評論、產生播放清單以及修改個人資訊。
   - 將使用者的功能以清單形式組織，便於伺服器根據請求調用對應模組。

7. **`utils.py`** (實用工具)
   - 包含多個輔助函式，例如用於選項列表的生成和處理客戶端選擇。
   - 使用直觀的方法處理客戶端與伺服器的互動細節，增強代碼重用性。
8. **`./action` 資料夾**
   - 每項執行動作被實作為一個類別，繼承抽象類別 `Action`，並實作其核心方法 `exec()`。
   - 此架構讓程式具備高度擴展性，開發者可透過新增 action 類別輕鬆增加新功能。



## 開發環境

- Windows 11、macOS 15.1

- Python: 3.9.6

  - psycopg2: 2.9.10
  - pandas: 2.2.3
  - tabulate: 0.9.0

- PostgreSQL: 16.4

  

## 參考資料

- 助教專案範例
